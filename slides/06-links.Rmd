---
title: "Links to other methods"
author: "David L Miller"
date: "August 14, 2020"
output:
  xaringan::moon_reader:
    css: ['default', 'https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css', 'slides.css']
    lib_dir: libs
    nature:
      titleSlideClass: ['inverse','middle','left',my-title-slide]
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      beforeInit: "macros.js"
      ratio: '16:9'
---

```{r setup, include=FALSE, cache=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(cache = TRUE, dev = 'svg', echo = TRUE, message = FALSE, warning = FALSE,
                      fig.height=6, fig.width = 1.777777*6)
library('here')
library('mgcv')
library('gratia')
library('gamair')
library('ggplot2')
library('purrr')
library('mvnfast')
library("tibble")
library('gganimate')
library('cowplot')
library('tidyr')
library("knitr")
library("viridis")
library('readr')
library('dplyr')
library('gganimate')
library('xaringan')
## plot defaults
theme_set(theme_minimal(base_size = 16, base_family = 'Fira Sans'))
## constants
anim_width <- 1000
anim_height <- anim_width / 1.77777777
anim_dev <- 'png'
anim_res <- 200
```

# So far:

- Looked at models within `mgcv`
  - `gam()`, `bam()`, `gamm()`

But there are other places to go.


---
class: inverse middle center big-subsection

## GAMs in context

---

# Lots of ways to fit flexible models!

- ðŸ’¬ "Why not use..."
  - INLA
  - kriging
  - MaxEnt
  - mixed effects models
  - ðŸ’¬ "... my favourite method"

<br/>

(**TL;DR: they are all GAMs**)

---

# Lots of things are just GLMs

- GAMs are "GLMs with wiggles"
- GLMMs are "GLMs with random effects"
- What is the general theme here?

- Interested in a *design matrix*, $\mathbf{X}$
- Impose some **structure** on the model

---

# Basis-penalty smoothers

For smoothers, we can always specify things as:

1. basis functions, $b_k(x)$, which we put in the design matrix
2. penalties, some function of $b_k(x)$s (usually integrals)

We call these *basis-penalty smoothers* in general.

In `mgcv` the `smooth.construct.*.smooth.spec` methods build design matrices and penalties.

---

# Bayesian links

We generally can write our penalized log-likelihood as:

$$
l(\boldsymbol{\beta}) - \frac{1}{2} \sum_{m=1}^M \lambda_m \boldsymbol{\beta}^{\intercal} \boldsymbol{S}_m \boldsymbol{\beta}
$$

Exponentiating (& merging all the penalty stuff):

$$
\mathcal{L}_p (\boldsymbol{\beta}, \boldsymbol{\lambda} ) = \mathcal{L}( \boldsymbol{\beta} ) \exp ( - \boldsymbol{\beta}^\intercal \mathbf{S}  \boldsymbol{\beta} )
$$

That $\exp ( - \boldsymbol{\beta}^\intercal \mathbf{S}  \boldsymbol{\beta} )$ term looks **a lot** like a normal distribution...

**A *prior*?** (https://arxiv.org/abs/1902.01330)

---

# Penalties, covariances, precisions

If $\exp ( - \boldsymbol{\beta}^\intercal \mathbf{S}  \boldsymbol{\beta} )$ is a normal prior on the coefficients...

- $\mathbf{S}$ is the penalty
- $\Rightarrow$ $\mathbf{S}$ is the precision
- $\Rightarrow$ $\mathbf{S}^{-1}$ is the covariance matrix!

Thinking about things in terms of these priors means we can write lots of models as GAMs!

---

# Random effects

- Fancy multi-level random effects models are just complicated $\mathbf{S}^{-1}$
- We've seen Markov random fields, same idea!


---

# Links to INLA, kriging

- INLA fits "latent Gaussian additive models" $\Rightarrow$ GAMs!
- INLA's SPDE method is a basis-penalty smoother
  - https://arxiv.org/abs/2001.07623
- Various kriging covariance functions can be written as basis-penalty smoothers
  - related to thin plate splines!
  
---

# MaxEnt

- Try to avoid presence only if you can!
- MaxEnt is just a Poisson process model
  - https://onlinelibrary.wiley.com/doi/10.1111/j.1541-0420.2012.01824.x
  - https://projecteuclid.org/euclid.aoas/1287409378
- We can write these as GLMs/GAMs!
- (and we know how GLMs/GAMs work!)


---

class: inverse middle center big-subsection

## Links to other software

---

# Basis-penalty/covariance opens things up

Lots of software just want design and covariance matrices:

- JAGS
- *brms*
- TMB
- Stan
- Nimble

---

# The `jagam` idea

- Write smooths as design matrices/precisions
- Normal prior on model coefficients
- Vague gamma prior on smoothing parameters
- Fit in JAGS
- `mgcv::jagam()` even generates the code for you!
- https://www.jstatsoft.org/article/view/v075i07

---

# JAGS sucks

- For complex models, JAGS can be very slow
- Nimble can really help, and works with JAGS code!
- Personal experience: 2 hour fit $\rightarrow$ 8 mins
- https://r-nimble.org/quick-guide-for-converting-from-jags-or-bugs-to-nimble


---

# We can do the same thing in TMB!

- Template Model Builder is extremely fast
- We can do a similar trick
- the `GMRF` function and sparse matrices help
- Worth it for **very** big models

---

# *brms*

*brms* is an R package for fitting Bayesian generalized (non-)linear multivariate multilevel models using 'Stan' for full Bayesian inference

It is largely the work of Paul-Christian BÃ¼rkner

*brms* can fit penalized smooth terms using `s()` and `t2()` all the basis types available in *mgcv*

Uses the same mixed model representation of smooths as is used in *gamm4*, which is why you can't use `te()` and `ti()`

Different `family` options are available (no Tweedie for example) but option to create custom family functions

---

# *brms* version of species richness model

```{r brms-richness-model, eval = FALSE}
brm(bf(richness ~ s(year)),
    data = shrimp, family = poisson(),
    iter = 4000, warmup = 1000, chains = 4)
```

* smooths are random effectsso uses default priors for random effect standard deviations
    * half Student *t* priors with 3 degrees of freedom and an appropriate scale parameter
* 4 chains
    * 4000 total samples per chain
	* first 1000 samples used as burn in & to tune the sampler

---

# *brms* version of the space-time model

There isn't a good family for this in *brms*; one option might be a hurdle gamma if we observed 0 shrimp biomass in some trawls

```{r brms-biomass-model, eval = FALSE}
brm(bf(shrimp ~ t2(x, y, year, d = c(2,1), bs = c('tp','cr'), k = c(20, 5)),
       hu ~ t2(x, y, year), d = c(2,1), bs = c('tp','cr'), k = c(20, 5)),
    data = shrimp, family = hurdle_gamma(),
    iter = 4000, warmup = 1000, chains = 4)
```

---

# Utility packages

- better graphics for GAMs: `gratia`, `mgcViz`
- extrapolation tool for SDMs: `dsmextra`
- very new: `mgcvUtils`

---

# *gratia*

*gratia's* main reason for existing is that I (Gavin) wanted to make it easier to work with *mgcv* models using *ggplot2* and the other *tidyverse* packages

*gratia* provides

* *ggplot2* implementation of `plot.gam()`: `draw.gam()`
* *ggplot2* implementation of `gam.check()`'s plots: `appraise()`
* derivatives of smooths (for estimating rates of change)
* simultaneous intervals for smooths (whole-function coverage)
* utilities for working with *mgcv* fits extracting info from them into tidy objects

<https://gavinsimpson.github.io/gratia/>

---

# *gratia* &mdash; `draw()`

```{r gratia-draw, echo = FALSE}
set.seed(2)
dat <- gamSim(1, n = 400, dist = "normal", scale = 2, verbose = FALSE)
#> Gu & Wahba 4 term additive model
m1 <- gam(y ~ s(x0) + s(x1) + s(x2) + s(x3), data = dat, method = "REML")

draw(m1, residuals = TRUE)
```

---

# *gratia* &mdash; `appraise()`

```{r gratia-appraise, echo = FALSE}
appraise(m1, point_col = "steelblue", point_alpha = 0.4, method = "simulate")
```

---

# Extrapolation

- Statisticians: don't do it!
- Managers: give me results!
- Variance issues?
- Space-time interchangability/transferability?
- `dsmextra` package by Phil Bouchet
  - [https://densitymodelling.github.io/dsmextra/index.html](https://densitymodelling.github.io/dsmextra/index.html)
  - paper accepted at Methods in Ecology and Evolution

![dsm extra logo](figures/dsmextra-hex.png)

---

# `mgcvUtils`

- Written by us! (& Matteo Fasiolo)
- Still being developed
- Extra utilities
  - interface for `DHARMa`
  - Markov random field helpers
  - SPDE smoother
  - More soon!
- https://github.com/dill/mgcvUtils

---

class: inverse middle center big-subsection

# Q&A
